<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <title>automaton</title>

    <style>
      body {
        background-color: black;
        margin: 0;
        overflow: hidden;
        padding: 0;
      }
      #automaton {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <canvas id="automaton"/>
    <script src="js/underscore.js"></script>
    <script src="js/automaton.js"></script>
    <script src="js/automaton-rule-parser.js"></script>
    <script src="js/automaton-artist.js"></script>
    <script type="text/javascript">
      window.maxCellsWide = 40;
      window.maxCellsHigh = 40;
      var winh = window.innerHeight;
      var winw = window.innerWidth;

      var cellSize = Math.ceil(_.max([window.innerHeight / window.maxCellsHigh, window.innerWidth / window.maxCellsWide]));
      var width = Math.ceil(winw / cellSize), height = Math.ceil(winh / cellSize);
      var v, h;
      var ch = parseInt(width / 2);
      var cv = parseInt(height / 2);

      window.grid = new Array(height);
      for (v = 0; v < height; v += 1) {
        grid[v] = new Array(width);
        for (h = 0; h < width; h += 1) {
          grid[v][h] = Math.floor(Math.random() * 0);
        }
      }
      window.grid[cv][ch-2] = 1;
      window.grid[cv][ch-1] = 1;
      window.grid[cv][ch] = 1;
      window.grid[cv][ch+1] = 1;
      window.grid[cv][ch+2] = 1;

      function makeNewArtist() {
        window.artist = new Automaton.Artist("automaton", width, height);
        artist.draw(grid);
      }
      makeNewArtist();
      window.onresize = makeNewArtist();

      window.rules = [
        "1: 0 && moore(1) == 2",
        "0"
      ]

      function debugGrid(grid) {
        var height = grid.length;
        var width = grid[0].length;
        var v, h;
        console.group("grid");
        for (v = 0; v < height; v += 1) {
          console.log(grid[v].join("\t"));
        }
        console.groupEnd();
      }

      var updateWorker = new Worker("js/automaton-update-worker.js");
      window.TIME_IS_FROZEN = false;
      updateWorker.onmessage = _.throttle(function (event) {
        if (event.data.type === "new grid") {
          grid = event.data.grid;
          artist.draw(grid);
          if (!window.TIME_IS_FROZEN) {
            updateWorker.postMessage({type: "updateGrid", grid: grid});
          }
        }
      }, 50);
      updateWorker.onerror = function (error) {
        console.log(error);
      }
      updateWorker.postMessage({type: "updateRules", rules: rules})
      updateWorker.postMessage({type: "updateGrid", grid: grid});
    </script>
  </body>
</html>
